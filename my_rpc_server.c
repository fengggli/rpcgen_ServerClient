/*
 * This is sample code generated by rpcgen.
 * These are only templates and you can use them
 * as a guideline for developing your own functions.
 */

#include "my_rpc.h"
#include <time.h>
#include <dirent.h>

/* 
 * function 1 get the server time
 */
char **
gettime_1_svc(void *argp, struct svc_req *rqstp)
{
	static char * result;

	/*
	 * insert server code here
	 */
    time_t thetime = time(0);
    result = ctime(&thetime);
    return &result;
}


/* 
 * function 2
 * merge two list
 */
intlist *
merge_1_svc(coupled_int_list *argp, struct svc_req *rqstp)
{
	static intlist  result;
    
	/*
	 * insert server code here
	 */

    /*
    result = NULL;

    intlist a = argp->a;
    intlist b = argp->b;

    intlist p;
    intlist tail = result;
    // try to merge two list
    while(p=a; p->next != NULL; p++){
        // get a new node
        intnode* tmp =  (intnode*)malloc(sizeof(intnode));
        tmp->next = NULL;
        if(result == NULL)

        

    }
    while
    */
        
	return &result;
}

/* 
 * function 3
 * reverse user input
 */
char **
reverse_1_svc(char **argp, struct svc_req *rqstp)
{
	static char * result;
    int i = 0;
    int length=0;

	/*
	 * insert server code here
	 */
    static char reversed[101];

    // get the length first
    while((*argp)[i]!='\n')
        i++;
    length = i;

    //now reverse
    for(i = 0; i< length; i++)
        reversed[i] = (*argp)[length -1 - i];

    reversed[i] = '\n';
    result = reversed;
	return &result;
}

/* 
 * function 4
 * read all the entries in a directory
 * code is original from here:
    https://docs.oracle.com/cd/E19683-01/816-1435/6m7rrfn7f/index.html 
 */
readdir_res *
readdir_1_svc(nametype *argp, struct svc_req *rqstp)
{
    DIR *dirp;
    struct dirent *d;
    namelist nl;
    namelist *nlp;
    static readdir_res res; /* must be static! */
    
    /* Open directory */
    dirp = opendir(*dirname);
    if (dirp == (DIR *)NULL) {
        res.errno = errno;
        return (&res);
    }
    /* Free previous result */
    xdr_free(xdr_readdir_res, &res);
    /*
     * Collect directory entries.
 * Memory allocated here is free by
     * xdr_free the next time readdir_1
 * is called
     */
    nlp = &res.readdir_res_u.list;
    while (d = readdir(dirp)) {
        nl = *nlp = (namenode *) 
                            malloc(sizeof(namenode));
        if (nl == (namenode *) NULL) {
            res.errno = EAGAIN;
            closedir(dirp);
            return(&res);
        }
        nl->name = strdup(d->d_name);
        nlp = &nl->next;
    }
    *nlp = (namelist)NULL;
    /* Return the result */
    res.errno = 0;
    closedir(dirp);
    return (&res);
}

/*
 * function 5
 * add two matrix and return the integer sum
 */
int *
addmatrix_1_svc(coupled_matrix *argp, struct svc_req *rqstp)
{
	static int  result;

	/*
	 * insert server code here
	 */
    // get the dimension

	return &result;
}
